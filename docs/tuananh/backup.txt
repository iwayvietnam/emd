#!/usr/bin/env bash
set -euo pipefail

ROLE="${ROLE:-policy}"                      # đổi theo máy
STAMP="$(date +%F)"
HOST="$(hostname -s)"
OUT="/backup/daily/${HOST}/${STAMP}"
mkdir -p "$OUT"

checksum() { ( cd "$OUT" && sha256sum *.tgz *.sql 2>/dev/null > SHA256SUMS.txt || true ); }

case "$ROLE" in
  smtp)
    tar -czf "${OUT}/postfix_configs.tgz" \
      /etc/postfix /etc/opendkim /etc/opendmarc /etc/aliases \
      /etc/ssl /etc/pki /etc/letsencrypt /var/lib/postfix 2>/dev/null || true
    ;;

  haproxy)
    tar -czf "${OUT}/haproxy_configs.tgz" \
      /etc/haproxy /etc/letsencrypt 2>/dev/null || true
    ;;

  policy) # Nginx
    tar -czf "${OUT}/nginx_configs.tgz" \
      /etc/nginx /etc/letsencrypt /var/www 2>/dev/null || true
    ;;

  db) # MySQL/MariaDB – cách nhanh (mysqldump)
    mysqldump --all-databases --single-transaction --routines --events --triggers \
      > "${OUT}/alldb_${STAMP}.sql"
    tar -czf "${OUT}/mysql_configs.tgz" /etc/my.cnf* /etc/mysql 2>/dev/null || true
    ;;

  dns)
    tar -czf "${OUT}/dns_configs.tgz" \
      /etc/named* /var/named /etc/unbound /etc/dnsmasq* 2>/dev/null || true
    ;;

  logmon)
    tar -czf "${OUT}/logmon_configs.tgz" \
      /etc/filebeat /etc/fluent-bit /etc/logstash /etc/kibana /etc/grafana /etc/prometheus \
      2>/dev/null || true
    # Elasticsearch snapshot (nếu có ES local, repo tên localfs)
    curl -s -X PUT "http://127.0.0.1:9200/_snapshot/localfs/snap-${STAMP}?wait_for_completion=true" \
      -H 'Content-Type: application/json' -d '{}' >/dev/null 2>&1 || true
    ;;
esac

checksum

# Retention (daily/weekly/monthly)
find "/backup/daily/${HOST}"   -mindepth 1 -maxdepth 1 -type d -mtime +7   -exec rm -rf {} + || true
find "/backup/weekly/${HOST}"  -mindepth 1 -maxdepth 1 -type d -mtime +35  -exec rm -rf {} + || true
find "/backup/monthly/${HOST}" -mindepth 1 -maxdepth 1 -type d -mtime +185 -exec rm -rf {} + || true

